---
import type { TargetContent } from "../src";
import Component from "./parts/Component.astro";
import SwitchResult from "./parts/SwitchResult.astro";
import TriggerButton from "./parts/TriggerButton.astro";
import TaggedMessageForm, { PresetName } from "./forms/TaggedMessageForm.astro";
import FeelbackForm from "./FeelbackForm.astro";

type Style =
  | "align-center" //
  | `width-${"sm" | "md"}` //
  | "bordered";

type Props = TargetContent & {
  style?: Style | Style[];
  layout?: "button-switch" | "button-dialog" | "inline" | "reveal-message";
  preset?: PresetName;
  title?: string;
  label?: string;
  showLabels?: boolean;
  minLength?: number;
  maxLength?: number;
  textAnswer?: string;
  placeholder?: string;
  preselect?: string | number | boolean;
};

const {
  style: _style,
  layout = "inline",
  label = "Send feedback",
  title = "Send feedback",
  textAnswer = "Thanks for your feedback",
  placeholder = "Type your message",
  preset = "feedback",
  minLength,
  maxLength,
  showLabels,
  preselect,
  ...target
} = Astro.props;

const style = Array.isArray(_style) ? _style.join(" ") : _style;
const behavior = layout === "button-dialog" ? "dialog" : layout === "button-switch" ? "switch" : undefined;

const formAttrs = {
  preset,
  title,
  placeholder,
  minLength,
  maxLength,
  showLabels,
  preselect: preselect === true ? undefined : preselect,
};

const btnCancelAttrs =
  layout === "button-switch"
    ? {
        "data-behavior-action": "switch",
        "data-behavior-target": ".trigger-btn",
        "data-behavior-source": ".feelback-form",
      }
    : {
        "data-behavior-action": "cancel",
      };
---

{
  (layout === "button-dialog" || layout === "button-switch") && (
    <Component
      component="form"
      class={`feelback-tagged-message layout-${layout} ${style || ""}`}
      behavior={behavior}
      {...target}
    >
      <SwitchResult textAnswer={textAnswer}>
        <TriggerButton
          action={layout === "button-dialog" ? "dialog" : "switch"}
          target=".feelback-form"
          label={label}
        />
        <TaggedMessageForm {...formAttrs} class={`hidden${layout === "button-dialog" ? " dialog" : ""}`}>
          <button slot="btn-cancel" class="feelback-btn btn-cancel" title="Cancel" {...btnCancelAttrs}>
            Cancel
          </button>
        </TaggedMessageForm>
      </SwitchResult>
    </Component>
  )
}

{
  layout === "reveal-message" && (
    <Component
      component="form"
      class={`feelback-tagged-message layout-${layout} ${style || ""}`}
      behavior={behavior}
      {...target}
    >
      <SwitchResult textAnswer={textAnswer}>
        <TaggedMessageForm layout="reveal" {...formAttrs} />
      </SwitchResult>
    </Component>
  )
}

{
  layout === "inline" && (
    <FeelbackForm class={`feelback-tagged-message layout-inline ${style || ""}`} textAnswer={textAnswer} {...target}>
      <TaggedMessageForm {...formAttrs} />
    </FeelbackForm>
  )
}
